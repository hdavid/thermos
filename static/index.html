<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv='Content-type' content='text/html; charset=utf-8'>
    <title>Thermos</title>
  </head>
	<style type="text/css" media="screen"> @import url("site.css");   </style>
  <body>
	
	<script src="js/react.js"></script>
	<script src="js/JSXTransformer.js"></script>
	<script src="js/jquery-1.10.0.min.js"></script>
	<script src="js/jquery.flot.js"></script>
	<script src="js/jquery.flot.time.js"></script>
	<script src="js/moment.js"></script>

	<script src="thermos.js" type="text/jsx"></script>
	
	<div id='notice'></div>	
	<div id="status"></div> 
	<div id="configForm"></div>
	<div id="schedule"></div>
	<div id="scheduleEntryForm"></div>
	
	<h2>Logs</h2>
	<a href="thermos.log">thermos.log</a>
	<a href="restApi.log">restApi.log</a>
	
	<h2 onClick="requestPlotData()">Graph</h2>

	<select id='plot-year'>
		<option value='2015'>2015</option>
	</select>
	<select id='plot-month'>
		<option value='01'>01</option>
		<option value='02'>02</option>
		<option value='03'>03</option>
		<option value='04'>04</option>
		<option value='05'>05</option>
		<option value='06'>06</option>
		<option value='07'>07</option>
		<option value='08'>08</option>
		<option value='09'>09</option>
		<option value='10'>10</option>
		<option value='11'>11</option>
		<option value='12'>12</option>
	</select>
	<a onClick="requestPlotData(document.getElementById('plot-year').value,document.getElementById('plot-month').value)">load</a>
		
	<span id='oneDay'>1d</span>
	<span id='twoDays'>2d</span>
	<span id='sevenDays'>7d</span>
	<span id='allDays'>all</span>
	
	<div id="placeholder" class="demo-placeholder" style="width:100%;height:250px"></div>


	<script type="text/jsx">
	
		React.render(
		  	<ConfigForm url={"config.json"} name="config"/>, 
			document.getElementById('configForm')
		);
	
		React.render(
			<Status url={"status.json"} name="status"/>,
			document.getElementById('status')
		);

		React.render(
			<Schedule url={"schedule.json"} name="schedule"/>,
			document.getElementById('schedule')
		);
	
    </script>
	

	<script type="text/javascript">

		var graphData;

		function requestPlotData(year,month){
			var filename ;
			if(year && month){
				filename = 'stats/'+year+"/"+month; 
			}else{
				filename = 'stats/'+moment().format('YYYY/MM'); 
			}
			$.ajax({
	      		url: filename,
	      		dataType: 'json',
	      		success: function(data) {
					try {
						d = data;
					    plot();
					} catch(err) {
						console.error(filename, status, err.message);
						$('#notice').html("error parsing data for 'stats.log' ! "+err.toString()).show().fadeOut(2000);
					}
	      		}.bind(this),
	      		error: function(xhr, status, err) {
	        		console.error(filename, status, err.toString());
					$('#notice').html("error loading 'stats.log' ! "+err.toString()).show().fadeOut(2000);
	      		}.bind(this)
	    	});
		};
		
		function plot(start,end) {
			if(!start){
				start = graphData.time[0];
			}
			if(!end){
				end =  graphData.time[d.time.length-1] 
			}
			
			$.plot(
				"#placeholder",
				[
					{ label: "mode", data: graphData.timeseries[0] },
					{ label: "heating", data: graphData.timeseries[1] },
					{ label: "scheduled", data: graphData.timeseries[2] },
					{ label: "actual", data: graphData.timeseries[3] },
				],
				{
					legend:{           
						position: 'sw'
					},
					series: {
						lines: {show: true},
						points: {show: false}
					},
					grid: {
						hoverable: true,
						clickable: true,
						backgroundColor: { colors: ["#999999", "#777777"] }	
					},
					xaxis: { 
						mode: "time",
						min: start,
						max: end 
					}
				}
			);
			$("<div id='tooltip'></div>").css({
				position: "absolute",
				display: "none",
				border: "0px solid #666666",
				padding: "3px",
				color:'#999999',
				background-color: "#dddddd",
				opacity: 0.80
			}).appendTo("body");

			$("#placeholder").bind("plothover", function (event, pos, item) {
				if (item) {
					//var x = item.datapoint[0].toFixed(2);
					var	y = item.datapoint[1].toFixed(2);
					$("#tooltip").html(item.series.label + " : " + y)
						.css({top: item.pageY+5, left: item.pageX+5})
						.fadeIn(200);
				} else {
					$("#tooltip").hide();
				}
			});
		};
		
		
		
		$("#oneDay").click(function () {
			var start = new Date()
			start.setDate(start.getDate()-1);
			plot((start).getTime(), (new Date()).getTime());
		});
		$("#twoDays").click(function () {
			var start = new Date()
			start.setDate(start.getDate()-2);
			plot((start).getTime(), (new Date()).getTime());
		});
		$("#sevenDays").click(function () {
			var start = new Date()
			start.setDate(start.getDate()-7);
			plot((start).getTime(), (new Date()).getTime());
		});
		$("#allDays").click(function () {
			plot();
		});

		requestPlotData();

	</script>
	
		
  </body>
</html>
