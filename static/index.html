<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv='Content-type' content='text/html; charset=utf-8'>
    <title>Thermos</title>
  </head>
	<style type="text/css" media="screen"> @import url("site.css");   </style>
  <body>
	
	<script src="js/react.js"></script>
	<script src="js/JSXTransformer.js"></script>
	<script src="js/jquery-1.10.0.min.js"></script>
	<script src="js/jquery.flot.js"></script>
	<script src="js/jquery.flot.time.js"></script>
	<script src="js/moment.js"></script>

	
	<script src="thermos.js" type="text/jsx"></script>
	
   	<!--h1>Thermos</h1-->

	<div id='notice'></div>
	
	<div id="status"></div> 
	
	<div id="configForm"></div>
	
	<div id="schedule"></div>

	<div id="scheduleEntryForm"></div>
	

    <script type="text/jsx">

		var rest_api = "";//use ourselves as api url. so we can leave that empty.
	
		React.render(
		  	<ConfigForm url={rest_api+"config.json"} name="config"/>, 
			document.getElementById('configForm')
		);
	
		React.render(
			<Status url={rest_api+"status.json"} name="status"/>,
			document.getElementById('status')
		);

		React.render(
			<Schedule url={rest_api+"schedule.json"} name="schedule"/>,
			document.getElementById('schedule')
		);
	
    </script>
	
	<h2>Logs</h2>

	<a href="thermos.log">thermos.log</a>
	<a href="restApi.log">restApi.log</a>
	
	<h2 onClick="requestPlot()">Graph</h2>
	<select id='plot-year'>
		<option value='2015'>2015</option>
	</select>
	<select id='plot-month'>
		<option value='01'>01</option>
		<option value='02'>02</option>
		<option value='03'>03</option>
		<option value='04'>04</option>
		<option value='05'>05</option>
		<option value='06'>06</option>
		<option value='07'>07</option>
		<option value='08'>08</option>
		<option value='09'>09</option>
		<option value='10'>10</option>
		<option value='11'>11</option>
		<option value='12'>12</option>
	</select>
	<a onClick="requestPlot(document.getElementById('plot-year').value,document.getElementById('plot-month').value)">load</a>
		
	<span id='oneDay'>1d</span>
	<span id='twoDays'>2d</span>
	<span id='sevenDays'>7d</span>
	<span id='allDays'>all</span>
	
	<div id="placeholder" class="demo-placeholder" style="width:100%;height:250px"></div>

	<script type="text/javascript">
		var d;
		
		function plot(start,end) {
			var dd = [
				{ label: "mode", data: d.timeseries[0] },
				{ label: "heating", data: d.timeseries[1] },
				{ label: "scheduled", data: d.timeseries[2] },
				{ label: "actual", data: d.timeseries[3] },
 			];

			if(!start){
				start = d.time[0];
			}
			if(!end){
				end =  d.time[d.time.length-1] 
			}
			
			$.plot(
				"#placeholder",
				dd,
				{
					legend:{           
						position: 'sw'
					},
					series: {
						lines: {show: true},
						points: {show: false}
					},
					grid: {
						hoverable: true,
						clickable: true,
						backgroundColor: { colors: ["#999999", "#777777"] }	
					},
					xaxis: { 
						mode: "time",
						min: start,
						max: end 
					}
				}
			);
			$("<div id='tooltip'></div>").css({
				position: "absolute",
				display: "none",
				border: "0px solid #666666",
				padding: "3px",
				color:'#999999',
				"background-color": "#dddddd",
				opacity: 0.80
			}).appendTo("body");

			$("#placeholder").bind("plothover", function (event, pos, item) {

				if (false && $("#enablePosition:checked").length > 0) {
					var str = "(" + pos.x.toFixed(2) + ", " + pos.y.toFixed(2) + ")";
					$("#hoverdata").text(str);
				}

				if (true || $("#enableTooltip:checked").length > 0) {
					if (item) {
						var x = item.datapoint[0].toFixed(2),
							y = item.datapoint[1].toFixed(2);

						$("#tooltip").html(item.series.label + " : " + y)
							.css({top: item.pageY+5, left: item.pageX+5})
							.fadeIn(200);
					} else {
						$("#tooltip").hide();
					}
				}
			});

			$("#placeholder").bind("plotclick", function (event, pos, item) {
				if (item) {
					$("#clickdata").text(" - click point " + item.dataIndex + " in " + item.series.label);
					plot.highlight(item.series, item.datapoint);
				}
			});
		};
		
		function requestPlot(year,month){
			var filename ;
			if(year && month){
				filename = 'stats/'+year+"/"+month; 
			}else{
				filename = 'stats/'+moment().format('YYYY/MM'); 
			}
			$.ajax({
	      		url: filename,
	      		dataType: 'json',
	      		success: function(data) {
					try {
						d = data;
					    plot();
					} catch(err) {
						console.error(filename, status, err.message);
						$('#notice').html("error parsing data for 'stats.log' ! "+err.toString()).show().fadeOut(2000);
					}
	      		}.bind(this),
	      		error: function(xhr, status, err) {
	        		console.error(filename, status, err.toString());
					$('#notice').html("error loading 'stats.log' ! "+err.toString()).show().fadeOut(2000);
	      		}.bind(this)
	    	});
		};
		
		$("#oneDay").click(function () {
			var start = new Date()
			start.setDate(start.getDate()-1);
			plot((start).getTime(), (new Date()).getTime());
		});
		$("#twoDays").click(function () {
			var start = new Date()
			start.setDate(start.getDate()-2);
			plot((start).getTime(), (new Date()).getTime());
		});
		$("#sevenDays").click(function () {
			var start = new Date()
			start.setDate(start.getDate()-7);
			plot((start).getTime(), (new Date()).getTime());
		});
		$("#allDays").click(function () {
			plot();
		});
	</script>
	
		
  </body>
</html>
